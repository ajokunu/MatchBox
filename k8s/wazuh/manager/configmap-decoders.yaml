# Custom Wazuh Log Decoders
# Parse structured log formats from K8s and container runtimes
apiVersion: v1
kind: ConfigMap
metadata:
  name: wazuh-custom-decoders
  namespace: wazuh
  labels:
    app: wazuh-manager
data:
  k8s-decoders.xml: |
    <!-- Kubernetes audit log decoder -->
    <decoder name="kubernetes-audit">
      <prematch>^{"kind":"Event","apiVersion":"audit.k8s.io</prematch>
    </decoder>

    <decoder name="kubernetes-audit-fields">
      <parent>kubernetes-audit</parent>
      <!-- Wazuh 4.14+ uses plugin_decoder for JSON extraction -->
      <plugin_decoder>JSON_Decoder</plugin_decoder>
    </decoder>

    <!-- Container runtime (containerd) log decoder -->
    <decoder name="containerd-log">
      <prematch>^time="</prematch>
    </decoder>

    <decoder name="containerd-log-fields">
      <parent>containerd-log</parent>
      <regex>^time="(\S+)" level=(\w+) msg="(.+)"</regex>
      <order>timestamp,severity,message</order>
    </decoder>

    <!-- K3s server log decoder -->
    <!-- K3s logs: E0227 17:19:09.816 12345 file.go:100] message -->
    <decoder name="k3s-server">
      <prematch>^E\d\d\d\d|^W\d\d\d\d|^I\d\d\d\d</prematch>
    </decoder>

    <decoder name="k3s-server-fields">
      <parent>k3s-server</parent>
      <!-- Wazuh OS_Regex: no {n} quantifiers, use repeated \d instead -->
      <regex>^(\w)\d\d\d\d (\S+)\s+\d+\s+(\S+):\d+] (.+)</regex>
      <order>severity,timestamp,source_file,message</order>
    </decoder>
