# OpenSearch Helm Values — Shared instance for Wazuh, OpenCTI, TheHive
# Chart: opensearch/opensearch (https://opensearch-project.github.io/helm-charts/)
#
# Why shared? Running separate ES/OpenSearch instances per service would cost
# 6-12GB RAM. A single shared instance with index-per-service isolation
# uses only 2GB. Trade-off: shared failure domain (acceptable for home lab).
#
# Install:
#   helm repo add opensearch https://opensearch-project.github.io/helm-charts/
#   helm install opensearch opensearch/opensearch -n shared -f opensearch.yaml

# Pin to OpenSearch 2.19.1 — Wazuh 4.14.3 requires OpenSearch 2.x
# (Wazuh Dashboard is based on OSD 2.19.4, incompatible with OS 3.x)
image:
  tag: "2.19.1"

# Single-node mode (no replicas — home lab doesn't need HA)
singleNode: true
replicas: 1

# Resource limits — slim config for 16GB Mac Mini
resources:
  requests:
    memory: "1.5Gi"
    cpu: "500m"
  limits:
    memory: "2Gi"
    cpu: "1000m"

# JVM heap — 1GB heap (half of 2GB container limit, OpenSearch best practice)
opensearchJavaOpts: "-Xmx1g -Xms1g"

# Persistent storage — 40GB for all indices
persistence:
  enabled: true
  size: "40Gi"
  storageClass: "local-path"  # k3s built-in provisioner

# Security — enabled with internal users for service-to-service auth
securityConfig:
  enabled: true
  config:
    securityConfigSecret: ""  # Uses default internal_users.yml
    dataComplete: false

# Mount custom TLS certs with correct SANs for K8s service hostname
secretMounts:
  - name: opensearch-certs
    secretName: opensearch-certs
    path: /usr/share/opensearch/config/certs

# Environment variables — credentials from K8s Secret
# DISABLE_INSTALL_DEMO_CONFIG prevents the Docker entrypoint from appending
# demo security config to opensearch.yml (which overrides our custom TLS certs).
extraEnvs:
  - name: OPENSEARCH_INITIAL_ADMIN_PASSWORD
    valueFrom:
      secretKeyRef:
        name: soc-shared-secrets
        key: opensearch-password
  - name: DISABLE_INSTALL_DEMO_CONFIG
    value: "true"

# Custom opensearch.yml — uses "config" key (NOT "extraConfig" which doesn't exist in chart).
# This creates a ConfigMap that the init container copies into the config directory.
# Index lifecycle — ISM policies applied via scripts/setup-ism.sh after OpenSearch starts.
config:
  opensearch.yml: |
    cluster.name: matchbox-soc
    plugins.index_state_management.enabled: true
    plugins.security.ssl.transport.pemcert_filepath: certs/esnode.pem
    plugins.security.ssl.transport.pemkey_filepath: certs/esnode-key.pem
    plugins.security.ssl.transport.pemtrustedcas_filepath: certs/root-ca.pem
    plugins.security.ssl.transport.enforce_hostname_verification: false
    plugins.security.ssl.http.enabled: true
    plugins.security.ssl.http.pemcert_filepath: certs/esnode.pem
    plugins.security.ssl.http.pemkey_filepath: certs/esnode-key.pem
    plugins.security.ssl.http.pemtrustedcas_filepath: certs/root-ca.pem
    plugins.security.allow_unsafe_democertificates: false
    plugins.security.allow_default_init_securityindex: true
    plugins.security.authcz.admin_dn:
      - "CN=admin,O=MatchBox,C=US"
    plugins.security.nodes_dn:
      - "CN=opensearch-node,O=MatchBox,C=US"
    plugins.security.audit.type: internal_opensearch
    plugins.security.restapi.roles_enabled: ["all_access", "security_rest_api_access"]
    plugins.security.system_indices.enabled: true
    plugins.security.system_indices.indices:
      [
        ".opendistro-alerting-config",
        ".opendistro-alerting-alert*",
        ".opendistro-anomaly-results*",
        ".opendistro-anomaly-detector*",
        ".opendistro-anomaly-checkpoints",
        ".opendistro-anomaly-detection-state",
        ".opendistro-reports-*",
        ".opensearch-notifications-*",
        ".opensearch-notebooks",
        ".opensearch-observability",
        ".ql-datasources",
        ".opendistro-asynchronous-search-response*",
        ".replication-metadata-store",
        ".opensearch-knn-models",
        ".plugins-ml-agent",
        ".plugins-ml-config",
        ".plugins-ml-connector",
        ".plugins-ml-controller",
        ".plugins-ml-model-group",
        ".plugins-ml-model",
        ".plugins-ml-task",
        ".plugins-ml-conversation-meta",
        ".plugins-ml-conversation-interactions",
        ".plugins-ml-memory-meta",
        ".plugins-ml-memory-message",
        ".plugins-ml-stop-words",
      ]

# Health probes — tcpSocket on port 9200
# Note: httpGet probes would be ideal (/_cluster/health) but the security plugin
# requires authentication on all HTTP endpoints, causing 401 probe failures.
# tcpSocket is the standard approach for OpenSearch with security enabled.
startupProbe:
  tcpSocket:
    port: 9200
  initialDelaySeconds: 30
  periodSeconds: 10
  failureThreshold: 30
readinessProbe:
  tcpSocket:
    port: 9200
  initialDelaySeconds: 10
  periodSeconds: 15
  failureThreshold: 3
livenessProbe:
  tcpSocket:
    port: 9200
  initialDelaySeconds: 60
  periodSeconds: 30
  failureThreshold: 5
